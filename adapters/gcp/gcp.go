package gcp

import (
	"context"
	"io/ioutil"

	log "github.com/robpaul9/golog"

	"cloud.google.com/go/storage"
	"github.com/pkg/errors"
)

type Config struct {
	Logger  log.Logger
	Context context.Context
}

type GCPInterface interface {
	DoesObjectExist(string, string) error
	ReadObjectBytes(string, string) ([]byte, error)
}

type Service struct {
	GCPInterface
	StorageClient *storage.Client
	*Config
}

func New(config *Config) *Service {
	config.Context = context.Background()

	storageClient, err := storage.NewClient(config.Context)
	if err != nil {
		config.Logger.Panic(err)
	}

	return &Service{
		StorageClient: storageClient,
		Config:        config,
	}
}

func (s *Service) DoesObjectExist(bucketName, objectName string) error {
	bkt := s.StorageClient.Bucket(bucketName)
	obj := bkt.Object(objectName)

	r, err := obj.NewReader(s.Context)

	if err != nil {
		return errors.Wrapf(err, "object not found")
	}
	defer r.Close()

	return nil

}

func (s *Service) ReadObjectBytes(bucketName, objectName string) ([]byte, error) {
	rc, err := s.StorageClient.Bucket(bucketName).Object(objectName).NewReader(s.Context)
	if err != nil {
		return nil, err
	}
	defer rc.Close()

	bytes, err := ioutil.ReadAll(rc)
	if err != nil {
		return nil, err
	}

	return bytes, nil
}
