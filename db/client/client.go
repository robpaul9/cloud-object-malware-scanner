package client

import (
	"context"

	"github.com/georgysavva/scany/pgxscan"

	"github.com/robpaul9/cloud-object-malware-scanner/db"
	"github.com/robpaul9/cloud-object-malware-scanner/models"
)

type IClientRepo interface {
	ClientExists(ctx context.Context, reqHeaders models.RequestHeaders) error
}

func New(db *db.DB) IClientRepo {
	return &clientRepo{db}
}

type clientRepo struct {
	db *db.DB
}

func (cr *clientRepo) ClientExists(ctx context.Context, reqHeaders models.RequestHeaders) error {
	var clientID string

	query := `
		SELECT client_id
		FROM clients 
		WHERE client_id=$1 AND client_secret=crypt($2, client_secret)
	`
	err := pgxscan.Get(ctx, cr.db.Connection, &clientID, query, reqHeaders.ClientID, reqHeaders.APIKey)

	return err
}
